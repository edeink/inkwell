var o=Object.defineProperty;var l=(i,s)=>o(i,"name",{value:s,configurable:!0});import{_ as c,C as r,c as d,o as g,ai as m,G as n,j as a,a as t}from"./chunks/framework.BnOgjZe9.js";const z=JSON.parse('{"title":"视图变换","description":"","frontmatter":{"title":"视图变换"},"headers":[],"relativePath":"docs/core/view-transform.md","filePath":"docs/core/view-transform.md"}'),h={name:"docs/core/view-transform.md"};function y(i,s,u,b,I,x){const p=r("InkMermaidBlock"),e=r("InkCodeBlock");return g(),d("div",null,[s[0]||(s[0]=m('<h1 id="视图变换" tabindex="-1">视图变换 <a class="header-anchor" href="#视图变换" aria-label="Permalink to &quot;视图变换&quot;">​</a></h1><h2 id="_1-概述" tabindex="-1">1. 概述 <a class="header-anchor" href="#_1-概述" aria-label="Permalink to &quot;1. 概述&quot;">​</a></h2><p>在 Inkwell 框架中，视图变换是指将组件的局部坐标系映射到屏幕（或父容器）坐标系的过程。这一过程对于实现缩放（Zoom）、平移（Pan）、旋转（Rotate）等交互效果至关重要。</p><p>本文档详细说明了 Inkwell 中的变换矩阵计算原理、与 Flutter 的对比以及在自定义组件（如 <code>MindMapViewport</code>）中的实现方式。</p><h2 id="_2-变换原理" tabindex="-1">2. 变换原理 <a class="header-anchor" href="#_2-变换原理" aria-label="Permalink to &quot;2. 变换原理&quot;">​</a></h2><p>Inkwell 使用基于步骤（Steps）的变换系统，最终组合成 2D 仿射变换矩阵。</p><h3 id="_2-1-坐标空间" tabindex="-1">2.1 坐标空间 <a class="header-anchor" href="#_2-1-坐标空间" aria-label="Permalink to &quot;2.1 坐标空间&quot;">​</a></h3><p>主要涉及以下坐标空间：</p><ul><li><strong>屏幕空间 (Screen Space)</strong>: 浏览器视口坐标。</li><li><strong>世界空间 (World Space)</strong>: 画布根节点的全局坐标。</li><li><strong>视口空间 (Viewport Space)</strong>: <code>MindMapViewport</code> 组件自身的局部坐标。</li><li><strong>内容空间 (Content Space)</strong>: 被视口包裹的内容（如节点）的坐标。</li></ul><h3 id="_2-2-变换流程" tabindex="-1">2.2 变换流程 <a class="header-anchor" href="#_2-2-变换流程" aria-label="Permalink to &quot;2.2 变换流程&quot;">​</a></h3><p>在 Inkwell 中，坐标变换贯穿于渲染管线（Rendering Pipeline）的始终。框架采用**局部坐标系（Local Coordinate System）**优先的设计原则，每个组件只需关心自身的相对位置和大小。</p><p>完整的变换流程如下：</p><ol><li><p><strong>布局阶段 (Layout)</strong>:</p><ul><li>父组件决定子组件的 <code>offset</code>（相对于父组件的偏移量）。</li><li>此 <code>offset</code> 存储在 <code>renderObject.offset</code> 中。</li></ul></li><li><p><strong>绘制阶段 (Paint)</strong>:</p><ul><li><strong>计算世界矩阵</strong>: 当前组件接收父组件传递的 <code>worldMatrix</code>，结合自身的 <code>offset</code>（及其他变换步骤），计算出当前组件的 <code>_worldMatrix</code>。</li><li><strong>应用渲染变换</strong>: 调用渲染器接口（如 <code>ctx.translate</code>），将绘图原点移动到组件左上角。</li><li><strong>绘制自身</strong>: 在局部坐标系 (0, 0) 处绘制背景、边框等。</li><li><strong>递归绘制子组件</strong>: 将新的 <code>worldMatrix</code> 传递给子组件，重复上述过程。</li></ul></li><li><p><strong>事件阶段 (HitTest)</strong>:</p><ul><li>将屏幕坐标（全局坐标）通过 <code>_worldMatrix</code> 的<strong>逆矩阵</strong>转换为局部坐标。</li><li>判断局部坐标是否在组件范围内 (<code>0 &lt;= x &lt;= width</code>, <code>0 &lt;= y &lt;= height</code>)。</li></ul></li></ol>',13)),n(p,{"code-base64":"Z3JhcGggVEQKICAgIHN1YmdyYXBoIFBpcGVsaW5lIFvmuLLmn5PnrqHnur9dCiAgICAgICAgQVtMYXlvdXQgUGhhc2VdIC0tPnxDb21wdXRlIE9mZnNldHwgQltQYWludCBQaGFzZV0KICAgICAgICBCIC0tPiBDe0hhcyBUcmFuc2Zvcm0/fQogICAgICAgIEMgLS0+fFllc3wgRFtBcHBseSBNYXRyaXhdCiAgICAgICAgQyAtLT58Tm98IEVbUGFpbnQgU2VsZl0KICAgICAgICBEIC0tPiBFCiAgICAgICAgRSAtLT4gRltQYWludCBDaGlsZHJlbl0KICAgIGVuZAo="}),s[1]||(s[1]=a("h3",{id:"_2-3-核心算法",tabindex:"-1"},[t("2.3 核心算法 "),a("a",{class:"header-anchor",href:"#_2-3-核心算法","aria-label":'Permalink to "2.3 核心算法"'},"​")],-1)),s[2]||(s[2]=a("p",null,"Inkwell 使用 3x2 的仿射变换矩阵（Affine Transform Matrix）来描述 2D 空间中的平移、缩放和旋转。",-1)),s[3]||(s[3]=a("h4",{id:"_2-3-1-矩阵乘法-forward-transform",tabindex:"-1"},[t("2.3.1 矩阵乘法 (Forward Transform) "),a("a",{class:"header-anchor",href:"#_2-3-1-矩阵乘法-forward-transform","aria-label":'Permalink to "2.3.1 矩阵乘法 (Forward Transform)"'},"​")],-1)),s[4]||(s[4]=a("p",null,"从局部空间到世界空间的转换遵循以下公式：",-1)),n(e,{"code-base64":"TV97d29ybGR9ID0gTV97cGFyZW50fSBcdGltZXMgTV97bG9jYWx9Cg==",lang:"math",meta:""}),s[5]||(s[5]=m('<p>其中 <code>$M_{local}$</code> 通常由组件的布局偏移量 <code>$T(dx, dy)$</code> 构成。对于高级组件（如 Viewport），<code>$M_{local}$</code> 可能包含缩放 <code>$S(sx, sy)$</code> 或旋转 <code>$R(\\theta)$</code>。</p><h4 id="_2-3-2-逆矩阵-inverse-transform" tabindex="-1">2.3.2 逆矩阵 (Inverse Transform) <a class="header-anchor" href="#_2-3-2-逆矩阵-inverse-transform" aria-label="Permalink to &quot;2.3.2 逆矩阵 (Inverse Transform)&quot;">​</a></h4><p>用于事件检测（Hit Test）。给定屏幕坐标 <code>$P_{screen}$</code>，计算局部坐标 <code>$P_{local}$</code>：</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>P</mi><mrow><mi>l</mi><mi>o</mi><mi>c</mi><mi>a</mi><mi>l</mi></mrow></msub><mo>=</mo><msubsup><mi>M</mi><mrow><mi>w</mi><mi>o</mi><mi>r</mi><mi>l</mi><mi>d</mi></mrow><mrow><mo>−</mo><mn>1</mn></mrow></msubsup><mo>×</mo><msub><mi>P</mi><mrow><mi>s</mi><mi>c</mi><mi>r</mi><mi>e</mi><mi>e</mi><mi>n</mi></mrow></msub></mrow><annotation encoding="application/x-tex">P_{local} = M_{world}^{-1} \\times P_{screen} </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.8641079999999999em;"></span><span class="strut bottom" style="height:1.1555469999999999em;vertical-align:-0.2914389999999999em;"></span><span class="base displaystyle textstyle uncramped"><span class="mord"><span class="mord mathit" style="margin-right:0.13889em;">P</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.13889em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mord mathit">o</span><span class="mord mathit">c</span><span class="mord mathit">a</span><span class="mord mathit" style="margin-right:0.01968em;">l</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">=</span><span class="mord"><span class="mord mathit" style="margin-right:0.10903em;">M</span><span class="vlist"><span style="top:0.2914389999999999em;margin-left:-0.10903em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit" style="margin-right:0.02691em;">w</span><span class="mord mathit">o</span><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mord mathit">d</span></span></span></span><span style="top:-0.4129999999999999em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord scriptstyle uncramped"><span class="mord">−</span><span class="mord mathrm">1</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mbin">×</span><span class="mord"><span class="mord mathit" style="margin-right:0.13889em;">P</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.13889em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit">s</span><span class="mord mathit">c</span><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mord mathit">e</span><span class="mord mathit">e</span><span class="mord mathit">n</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span></span></p><h4 id="_2-3-3-坐标系转换公式" tabindex="-1">2.3.3 坐标系转换公式 <a class="header-anchor" href="#_2-3-3-坐标系转换公式" aria-label="Permalink to &quot;2.3.3 坐标系转换公式&quot;">​</a></h4><p>对于点 <code>$(x, y)$</code> 应用矩阵 <code>$[a, b, c, d, tx, ty]$</code>：</p>',6)),n(e,{"code-base64":"eCcgPSBhIFxjZG90IHggKyBjIFxjZG90IHkgKyB0eAp5JyA9IGIgXGNkb3QgeCArIGQgXGNkb3QgeSArIHR5Cg==",lang:"math",meta:""}),s[6]||(s[6]=a("h2",{id:"_3-源码解析",tabindex:"-1"},[t("3. 源码解析 "),a("a",{class:"header-anchor",href:"#_3-源码解析","aria-label":'Permalink to "3. 源码解析"'},"​")],-1)),s[7]||(s[7]=a("p",null,"以下代码用于说明变换逻辑的关键步骤（为便于阅读做了简化）。真实实现请以 [base.ts](file:///Users/edeink/Documents/inkwell/src/core/base.ts) 与 [viewport.ts](file:///Users/edeink/Documents/inkwell/src/core/viewport/viewport.ts) 为准。",-1)),s[8]||(s[8]=a("h3",{id:"_3-1-widget-paint-base-ts",tabindex:"-1"},[t("3.1 Widget.paint (base.ts) "),a("a",{class:"header-anchor",href:"#_3-1-widget-paint-base-ts","aria-label":'Permalink to "3.1 Widget.paint (base.ts)"'},"​")],-1)),s[9]||(s[9]=a("p",null,[a("code",null,"Widget"),t(" 基类负责维护世界矩阵并管理渲染上下文的保存与恢复。")],-1)),n(e,{"code-base64":"Ly8gc3JjL2NvcmUvYmFzZS50cwoKcGFpbnQoY29udGV4dDogQnVpbGRDb250ZXh0KTogdm9pZCB7CiAgLy8gMS4g6I635Y+W5bGA6YOo5Y+Y5o2i5q2l6aqkICjpgJrluLjmmK/luIPlsYDlgY/np7spCiAgY29uc3Qgc3RlcHMgPSB0aGlzLmdldFNlbGZUcmFuc2Zvcm1TdGVwcygpOyAvLyBbeyB0OiAndHJhbnNsYXRlJywgeDogb2Zmc2V0LmR4LCB5OiBvZmZzZXQuZHkgfV0KICAKICAvLyAyLiDorqHnrpflvZPliY3oioLngrnnmoTkuJbnlYznn6npmLUKICBjb25zdCBwcmV2ID0gY29udGV4dC53b3JsZE1hdHJpeCA/PyBJREVOVElUWV9NQVRSSVg7CiAgY29uc3QgbmV4dCA9IG11bHRpcGx5KHByZXYsIGNvbXBvc2VTdGVwcyhzdGVwcykpOwogIHRoaXMuX3dvcmxkTWF0cml4ID0gbmV4dDsgLy8g57yT5a2Y55+p6Zi15L6bIEhpdFRlc3Qg5L2/55SoCgogIC8vIDMuIOW6lOeUqOWPmOaNouWIsOa4suafk+WZqCAoQ2FudmFzIENvbnRleHQpCiAgY29udGV4dC5yZW5kZXJlcj8uc2F2ZT8uKCk7CiAgYXBwbHlTdGVwcyhjb250ZXh0LnJlbmRlcmVyLCBzdGVwcyk7CgogIC8vIDQuIOe7mOWItuiHqui6qwogIHRoaXMucGFpbnRTZWxmKHsgLi4uY29udGV4dCwgd29ybGRNYXRyaXg6IG5leHQgfSk7CgogIC8vIDUuIOe7mOWItuWtkOe7hOS7tgogIGZvciAoY29uc3QgY2hpbGQgb2YgdGhpcy5jaGlsZHJlbikgewogICAgY2hpbGQucGFpbnQoeyAuLi5jb250ZXh0LCB3b3JsZE1hdHJpeDogbmV4dCB9KTsKICB9CgogIC8vIDYuIOaBouWkjea4suafk+WZqOeKtuaAgQogIGNvbnRleHQucmVuZGVyZXI/LnJlc3RvcmU/LigpOwp9Cg==",lang:"typescript",meta:""}),s[10]||(s[10]=a("h3",{id:"_3-2-hittest-实现",tabindex:"-1"},[t("3.2 HitTest 实现 "),a("a",{class:"header-anchor",href:"#_3-2-hittest-实现","aria-label":'Permalink to "3.2 HitTest 实现"'},"​")],-1)),s[11]||(s[11]=a("p",null,"利用缓存的世界矩阵进行逆变换，实现精准的点击检测。",-1)),n(e,{"code-base64":"Ly8gc3JjL2NvcmUvYmFzZS50cwoKcHVibGljIGhpdFRlc3QoeDogbnVtYmVyLCB5OiBudW1iZXIpOiBib29sZWFuIHsKICBpZiAodGhpcy5fd29ybGRNYXRyaXgpIHsKICAgIC8vIDEuIOiuoeeul+mAhuefqemYte+8iOW5tuWPr+e8k+WtmOS7peWHj+WwkemHjeWkjeiuoeeul++8iQogICAgY29uc3QgaW52ID0gaW52ZXJ0KHRoaXMuX3dvcmxkTWF0cml4KTsKICAgIC8vIDIuIOWwhuWFqOWxgOWdkOagh+i9rOaNouS4uuWxgOmDqOWdkOaghwogICAgY29uc3QgbG9jYWwgPSB0cmFuc2Zvcm1Qb2ludChpbnYsIHsgeCwgeSB9KTsKICAgIAogICAgLy8gMy4g5qOA5p+l54K55piv5ZCm5Zyo55+p5b2i6IyD5Zu05YaFCiAgICBjb25zdCB3ID0gdGhpcy5yZW5kZXJPYmplY3Quc2l6ZS53aWR0aDsKICAgIGNvbnN0IGggPSB0aGlzLnJlbmRlck9iamVjdC5zaXplLmhlaWdodDsKICAgIHJldHVybiBsb2NhbC54ID49IDAgJiYgbG9jYWwueSA+PSAwICYmIGxvY2FsLnggPD0gdyAmJiBsb2NhbC55IDw9IGg7CiAgfQogIHJldHVybiBmYWxzZTsKfQo=",lang:"typescript",meta:""}),s[12]||(s[12]=m('<h2 id="_4-视口变换实战-viewport" tabindex="-1">4. 视口变换实战（Viewport） <a class="header-anchor" href="#_4-视口变换实战-viewport" aria-label="Permalink to &quot;4. 视口变换实战（Viewport）&quot;">​</a></h2><p><code>Viewport</code> 是一个典型的自定义变换组件，它在标准布局偏移之外，额外引入了“视口变换”（缩放和平移）。</p><h3 id="_4-1-变换逻辑" tabindex="-1">4.1 变换逻辑 <a class="header-anchor" href="#_4-1-变换逻辑" aria-label="Permalink to &quot;4.1 变换逻辑&quot;">​</a></h3><p>在 <code>Viewport</code> 组件中，变换分为两层：</p><ol><li><strong>自身布局变换</strong>: 决定 Viewport 在父容器中的位置。</li><li><strong>内部视口变换</strong>: 决定子组件（内容）的缩放和平移。</li></ol><h3 id="_4-2-代码实现" tabindex="-1">4.2 代码实现 <a class="header-anchor" href="#_4-2-代码实现" aria-label="Permalink to &quot;4.2 代码实现&quot;">​</a></h3>',6)),n(e,{"code-base64":"Ly8gc3JjL2NvcmUvdmlld3BvcnQvdmlld3BvcnQudHMKCnBhaW50KGNvbnRleHQ6IEJ1aWxkQ29udGV4dCk6IHZvaWQgewogIC8vIC4uLiAo55yB55Wl6Ieq6Lqr57uY5Yi25Luj56CBKSAuLi4KCiAgLy8g5a6a5LmJ6KeG5Y+j5Y+Y5o2i5q2l6aqkCiAgLy8g5rOo5oSP77yaSW5rd2VsbCDnmoTnn6npmLXnu4TlkIjph4fnlKjigJzlkI7kuZjigJ3vvIhtID0gbSAqIHN0ZXBNYXRyaXjvvInvvIzlm6DmraQgc3RlcHMg5pWw57uE5Lit5ZCO6Z2i55qE5Y+Y5o2i5Lya5pu05pep5L2c55So5LqO54K544CCCiAgLy8g5L6L5aaC77yadmlld1N0ZXBzID0gW3RyYW5zbGF0ZSwgc2NhbGVdIOe7hOWQiOefqemYteaYryBUICogU++8jOWvueeCueeahOaViOaenOaYr+KAnOWFiOe8qeaUvu+8jOWGjeW5s+enu+KAneOAggogIGNvbnN0IHZpZXdTdGVwczogVHJhbnNmb3JtU3RlcFtdID0gWwogICAgeyB0OiAndHJhbnNsYXRlJywgeDogdGhpcy5fdHgsIHk6IHRoaXMuX3R5IH0sCiAgICB7IHQ6ICdzY2FsZScsIHN4OiB0aGlzLl9zY2FsZSwgc3k6IHRoaXMuX3NjYWxlIH0sCiAgXTsKCiAgLy8g5bqU55So6KeG5Y+j5Y+Y5o2i5Yiw5riy5p+T5ZmoCiAgYXBwbHlTdGVwcyhjb250ZXh0LnJlbmRlcmVyLCB2aWV3U3RlcHMpOwoKICAvLyDmm7TmlrDlrZDnu4Tku7bnmoTkuJbnlYznn6npmLUKICBjb25zdCB2aWV3TG9jYWwgPSBjb21wb3NlU3RlcHModmlld1N0ZXBzKTsKICAvLyBjaGlsZE1hdHJpeCA9IHBhcmVudE1hdHJpeCAqIHZpZXdNYXRyaXgKICBjb25zdCBjaGlsZE1hdHJpeCA9IG11bHRpcGx5KHRoaXMuX3dvcmxkTWF0cml4ISwgdmlld0xvY2FsKTsKCiAgLy8g57uY5Yi25a2Q57uE5Lu2ICjlhoXlrrkpCiAgLy8g5rOo5oSP77ya5a2Q57uE5Lu26YCa5bi46L+Y5pyJ6Ieq6Lqr55qE5rua5Yqo5YGP56e7ICgtc2Nyb2xsWCwgLXNjcm9sbFkpCiAgZm9yIChjb25zdCBjaGlsZCBvZiBjaGlsZHJlbikgewogICAgY2hpbGQucGFpbnQoeyAuLi5jb250ZXh0LCB3b3JsZE1hdHJpeDogY2hpbGRNYXRyaXggfSk7CiAgfQogIAogIC8vIC4uLgp9Cg==",lang:"typescript",meta:""}),s[13]||(s[13]=a("h3",{id:"_4-3-数学验证",tabindex:"-1"},[t("4.3 数学验证 "),a("a",{class:"header-anchor",href:"#_4-3-数学验证","aria-label":'Permalink to "4.3 数学验证"'},"​")],-1)),n(p,{"code-base64":"Z3JhcGggTFIKICAgIFBfY29udGVudFtQIGNvbnRlbnRdIC0tPnxUcmFuc2xhdGUgLXNjcm9sbHwgUF9zY3JvbGxlZAogICAgUF9zY3JvbGxlZCAtLT58U2NhbGUgc3wgUF9zY2FsZWQKICAgIFBfc2NhbGVkIC0tPnxUcmFuc2xhdGUgdHgsdHl8IFBfc2NyZWVuW1Agc2NyZWVuXQo="}),s[14]||(s[14]=m('<p>假设：</p><ul><li>Viewport 偏移: <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>T</mi><mo>(</mo><mi>t</mi><mi>x</mi><mo separator="true">,</mo><mi>t</mi><mi>y</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">T(tx, ty)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.13889em;">T</span><span class="mopen">(</span><span class="mord mathit">t</span><span class="mord mathit">x</span><span class="mpunct">,</span><span class="mord mathit">t</span><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="mclose">)</span></span></span></span></li><li>缩放比例: <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>S</mi><mo>(</mo><mi>s</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">S(s)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.05764em;">S</span><span class="mopen">(</span><span class="mord mathit">s</span><span class="mclose">)</span></span></span></span></li><li>内容滚动偏移: <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>O</mi><mi>f</mi><mi>f</mi><mi>s</mi><mi>e</mi><msub><mi>t</mi><mrow><mi>s</mi><mi>c</mi><mi>r</mi><mi>o</mi><mi>l</mi><mi>l</mi></mrow></msub><mo>(</mo><mo>−</mo><mi>s</mi><mi>x</mi><mo separator="true">,</mo><mo>−</mo><mi>s</mi><mi>y</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">Offset_{scroll}(-sx, -sy)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.02778em;">O</span><span class="mord mathit" style="margin-right:0.10764em;">f</span><span class="mord mathit" style="margin-right:0.10764em;">f</span><span class="mord mathit">s</span><span class="mord mathit">e</span><span class="mord"><span class="mord mathit">t</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit">s</span><span class="mord mathit">c</span><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mord mathit">o</span><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mord mathit" style="margin-right:0.01968em;">l</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mopen">(</span><span class="mord">−</span><span class="mord mathit">s</span><span class="mord mathit">x</span><span class="mpunct">,</span><span class="mord">−</span><span class="mord mathit">s</span><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="mclose">)</span></span></span></span></li><li>内容原始坐标: <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>P</mi><mrow><mi>c</mi><mi>o</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>n</mi><mi>t</mi></mrow></msub></mrow><annotation encoding="application/x-tex">P_{content}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="base textstyle uncramped"><span class="mord"><span class="mord mathit" style="margin-right:0.13889em;">P</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.13889em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit">c</span><span class="mord mathit">o</span><span class="mord mathit">n</span><span class="mord mathit">t</span><span class="mord mathit">e</span><span class="mord mathit">n</span><span class="mord mathit">t</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span></li></ul><p>最终屏幕坐标 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>P</mi><mrow><mi>s</mi><mi>c</mi><mi>r</mi><mi>e</mi><mi>e</mi><mi>n</mi></mrow></msub></mrow><annotation encoding="application/x-tex">P_{screen}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="base textstyle uncramped"><span class="mord"><span class="mord mathit" style="margin-right:0.13889em;">P</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.13889em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit">s</span><span class="mord mathit">c</span><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mord mathit">e</span><span class="mord mathit">e</span><span class="mord mathit">n</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span> 计算如下：</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>P</mi><mrow><mi>s</mi><mi>c</mi><mi>r</mi><mi>e</mi><mi>e</mi><mi>n</mi></mrow></msub><mo>=</mo><mi>T</mi><mo>(</mo><mi>t</mi><mi>x</mi><mo separator="true">,</mo><mi>t</mi><mi>y</mi><mo>)</mo><mo>×</mo><mi>S</mi><mo>(</mo><mi>s</mi><mo>)</mo><mo>×</mo><mi>T</mi><mo>(</mo><mo>−</mo><mi>s</mi><mi>x</mi><mo separator="true">,</mo><mo>−</mo><mi>s</mi><mi>y</mi><mo>)</mo><mo>×</mo><msub><mi>P</mi><mrow><mi>c</mi><mi>o</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>n</mi><mi>t</mi></mrow></msub></mrow><annotation encoding="application/x-tex">P_{screen} = T(tx, ty) \\times S(s) \\times T(-sx, -sy) \\times P_{content} </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base displaystyle textstyle uncramped"><span class="mord"><span class="mord mathit" style="margin-right:0.13889em;">P</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.13889em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit">s</span><span class="mord mathit">c</span><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mord mathit">e</span><span class="mord mathit">e</span><span class="mord mathit">n</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">=</span><span class="mord mathit" style="margin-right:0.13889em;">T</span><span class="mopen">(</span><span class="mord mathit">t</span><span class="mord mathit">x</span><span class="mpunct">,</span><span class="mord mathit">t</span><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="mclose">)</span><span class="mbin">×</span><span class="mord mathit" style="margin-right:0.05764em;">S</span><span class="mopen">(</span><span class="mord mathit">s</span><span class="mclose">)</span><span class="mbin">×</span><span class="mord mathit" style="margin-right:0.13889em;">T</span><span class="mopen">(</span><span class="mord">−</span><span class="mord mathit">s</span><span class="mord mathit">x</span><span class="mpunct">,</span><span class="mord">−</span><span class="mord mathit">s</span><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="mclose">)</span><span class="mbin">×</span><span class="mord"><span class="mord mathit" style="margin-right:0.13889em;">P</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.13889em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit">c</span><span class="mord mathit">o</span><span class="mord mathit">n</span><span class="mord mathit">t</span><span class="mord mathit">e</span><span class="mord mathit">n</span><span class="mord mathit">t</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span></span></p><p>化简为代数形式：</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>x</mi><mrow><mi>s</mi><mi>c</mi><mi>r</mi><mi>e</mi><mi>e</mi><mi>n</mi></mrow></msub><mo>=</mo><mo>(</mo><msub><mi>x</mi><mrow><mi>c</mi><mi>o</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>n</mi><mi>t</mi></mrow></msub><mo>−</mo><mi>s</mi><mi>x</mi><mo>)</mo><mo>⋅</mo><mi>s</mi><mo>+</mo><mi>t</mi><mi>x</mi><msub><mi>y</mi><mrow><mi>s</mi><mi>c</mi><mi>r</mi><mi>e</mi><mi>e</mi><mi>n</mi></mrow></msub><mo>=</mo><mo>(</mo><msub><mi>y</mi><mrow><mi>c</mi><mi>o</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>n</mi><mi>t</mi></mrow></msub><mo>−</mo><mi>s</mi><mi>y</mi><mo>)</mo><mo>⋅</mo><mi>s</mi><mo>+</mo><mi>t</mi><mi>y</mi></mrow><annotation encoding="application/x-tex">x_{screen} = (x_{content} - sx) \\cdot s + tx y_{screen} = (y_{content} - sy) \\cdot s + ty </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base displaystyle textstyle uncramped"><span class="mord"><span class="mord mathit">x</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit">s</span><span class="mord mathit">c</span><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mord mathit">e</span><span class="mord mathit">e</span><span class="mord mathit">n</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">=</span><span class="mopen">(</span><span class="mord"><span class="mord mathit">x</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit">c</span><span class="mord mathit">o</span><span class="mord mathit">n</span><span class="mord mathit">t</span><span class="mord mathit">e</span><span class="mord mathit">n</span><span class="mord mathit">t</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mbin">−</span><span class="mord mathit">s</span><span class="mord mathit">x</span><span class="mclose">)</span><span class="mbin">⋅</span><span class="mord mathit">s</span><span class="mbin">+</span><span class="mord mathit">t</span><span class="mord mathit">x</span><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit">s</span><span class="mord mathit">c</span><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mord mathit">e</span><span class="mord mathit">e</span><span class="mord mathit">n</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">=</span><span class="mopen">(</span><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit">c</span><span class="mord mathit">o</span><span class="mord mathit">n</span><span class="mord mathit">t</span><span class="mord mathit">e</span><span class="mord mathit">n</span><span class="mord mathit">t</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mbin">−</span><span class="mord mathit">s</span><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="mclose">)</span><span class="mbin">⋅</span><span class="mord mathit">s</span><span class="mbin">+</span><span class="mord mathit">t</span><span class="mord mathit" style="margin-right:0.03588em;">y</span></span></span></span></span></p><p>这确保了用户在操作缩放和平移时，内容的视觉呈现符合直觉。</p><h2 id="_5-最佳实践" tabindex="-1">5. 最佳实践 <a class="header-anchor" href="#_5-最佳实践" aria-label="Permalink to &quot;5. 最佳实践&quot;">​</a></h2><ol><li><strong>缓存矩阵</strong>: <code>_worldMatrix</code> 应在每一帧绘制时更新并缓存，避免在 <code>hitTest</code> 等高频操作中重复计算矩阵乘法。</li><li><strong>减少嵌套</strong>: 过深的组件嵌套会导致矩阵乘法链过长，虽然计算开销尚可，但可能引入浮点数精度误差。</li><li><strong>使用 <code>save/restore</code></strong>: 修改渲染器变换状态前务必调用 <code>save()</code>，操作结束后调用 <code>restore()</code>，防止污染兄弟组件的渲染上下文。</li><li><strong>变换顺序</strong>: 牢记变换是不可交换的，并注意 steps 的“后乘”规则：steps 中后面的变换会更早作用于点。要得到“先缩放再平移”的效果，steps 通常写成 <code>[translate, scale]</code>。</li></ol>',9))])}l(y,"_sfc_render");const w=c(h,[["render",y]]);export{z as __pageData,w as default};
