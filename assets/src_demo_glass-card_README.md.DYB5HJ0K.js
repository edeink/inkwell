import{_ as s,c as l,o as a,ai as d}from"./chunks/framework.Ckc8SVM3.js";const g=JSON.parse('{"title":"glass-card 示例说明","description":"","frontmatter":{},"headers":[],"relativePath":"src/demo/glass-card/README.md","filePath":"src/demo/glass-card/README.md"}'),o={name:"src/demo/glass-card/README.md"};function t(i,e,c,r,n,u){return a(),l("div",null,[...e[0]||(e[0]=[d('<h1 id="glass-card-示例说明" tabindex="-1">glass-card 示例说明 <a class="header-anchor" href="#glass-card-示例说明" aria-label="Permalink to &quot;glass-card 示例说明&quot;">​</a></h1><p>本目录是一个“磨砂玻璃卡片”示例（Canvas2D 自绘），核心组件为 <code>FrostedGlassCard</code>，并通过 <code>GlassCardComposite</code> 组合出“底层磨砂 + 上层文本内容”的完整卡片。</p><h2 id="目录结构" tabindex="-1">目录结构 <a class="header-anchor" href="#目录结构" aria-label="Permalink to &quot;目录结构&quot;">​</a></h2><ul><li><code>index.tsx</code>：React 宿主入口，挂载 <code>InkwellCanvas</code>，在初始化/resize/主题变化时调用 <code>runApp</code> 触发重渲染。</li><li><code>app.tsx</code>：demo 的 Widget 树入口，包含页面布局、两张示例卡片与文案。</li><li><code>widgets/</code><ul><li><code>frosted-glass-card/index.ts</code>：核心绘制组件（磨砂层 + 清晰窗口 + 底图缓存 + 文本采样回调）。</li><li><code>glass-card-composite/index.tsx</code>：组合示例组件（底层 <code>FrostedGlassCard</code> + 上层文本内容），并使用采样结果更新文字样式。</li><li><code>glass-button/index.tsx</code>：玻璃按钮组件（交互状态 + 特效调度），特效实现拆分在 <code>glass-button/effects/</code>。</li></ul></li><li><code>helpers/</code><ul><li><code>canvas.ts</code>：少量 Canvas 相关工具（圆角路径、可复现伪随机）。</li><li><code>color-sampling.ts</code>：颜色采样与推荐文字样式（fast 1x1 缩放采样 + getImageData 回退）。</li><li><code>frosted-glass-card-paint.ts</code>：从 <code>FrostedGlassCard</code> 抽出的绘制函数（底图层渲染、磨砂覆盖、清晰窗口与边框）。</li></ul></li><li><code>__tests__/frosted-glass-card.spec.ts</code>：核心行为测试（缓存复用、key 刷新、layout/paint 更新策略等）。</li><li><code>assets/</code>：示例图片资源。</li></ul><h2 id="运行入口与渲染链路" tabindex="-1">运行入口与渲染链路 <a class="header-anchor" href="#运行入口与渲染链路" aria-label="Permalink to &quot;运行入口与渲染链路&quot;">​</a></h2><ol><li>React 侧渲染 <code>index.tsx</code>，内部挂载 <code>InkwellCanvas</code>。</li><li><code>InkwellCanvas</code> 初始化完成后提供 <code>Runtime</code> 实例，触发 <code>runApp(runtime, width, height, theme)</code>。</li><li><code>runApp</code> 在 <code>app.tsx</code> 中构建 <code>GlassCardDemoApp</code>，最终渲染两张 <code>GlassCardComposite</code>。</li><li><code>GlassCardComposite</code> 内部将 <code>FrostedGlassCard</code> 作为底层，文本内容（<code>Text</code>）作为上层叠加，从而避免文本被磨砂层二次模糊。</li></ol><h2 id="组件关系与职责划分" tabindex="-1">组件关系与职责划分 <a class="header-anchor" href="#组件关系与职责划分" aria-label="Permalink to &quot;组件关系与职责划分&quot;">​</a></h2><h3 id="glasscardcomposite-组合层" tabindex="-1">GlassCardComposite（组合层） <a class="header-anchor" href="#glasscardcomposite-组合层" aria-label="Permalink to &quot;GlassCardComposite（组合层）&quot;">​</a></h3><ul><li>负责把“磨砂底层”和“上层内容”组合在一起。</li><li>负责计算 <code>textSampleRect</code>（文本区域的采样矩形），并把它传给 <code>FrostedGlassCard</code>。</li><li>通过 <code>onSuggestedTextStyleChange</code> 接收 <code>FrostedGlassCard</code> 的推荐文字样式（<code>fill/stroke</code>），并用 <code>setState</code> 更新上层文本渲染参数。</li></ul><p>对应实现：[index.tsx](file:///Users/edeink/Documents/inkwell/src/demo/glass-card/widgets/glass-card-composite/index.tsx)</p><h3 id="frostedglasscard-渲染层" tabindex="-1">FrostedGlassCard（渲染层） <a class="header-anchor" href="#frostedglasscard-渲染层" aria-label="Permalink to &quot;FrostedGlassCard（渲染层）&quot;">​</a></h3><p>目标：在一个 Widget 内完成以下绘制效果：</p><ul><li>卡片圆角裁剪</li><li>“窗口外区域”磨砂模糊</li><li>“窗口区域”保持清晰</li><li>可选扫光动画（60fps）</li><li>可选对指定区域做一次颜色采样，并回调推荐文字样式</li></ul><p>对应实现：[index.ts](file:///Users/edeink/Documents/inkwell/src/demo/glass-card/widgets/frosted-glass-card/index.ts)</p><h3 id="glassbutton-交互-特效调度" tabindex="-1">GlassButton（交互 + 特效调度） <a class="header-anchor" href="#glassbutton-交互-特效调度" aria-label="Permalink to &quot;GlassButton（交互 + 特效调度）&quot;">​</a></h3><p><code>GlassButton</code> 是同一套磨砂玻璃视觉语言下的“按钮组件”，支持 hover/press 动画，并把特效实现拆成独立模块统一调度：</p><ul><li>入口：[index.tsx](file:///Users/edeink/Documents/inkwell/src/demo/glass-card/widgets/glass-button/index.tsx)</li><li>特效目录：[effects](file:///Users/edeink/Documents/inkwell/src/demo/glass-card/widgets/glass-button/effects)</li><li>测试文件：[glass-button.effects.test.ts](file:///Users/edeink/Documents/inkwell/src/demo/glass-card/widgets/glass-button/<strong>tests</strong>/glass-button.effects.test.ts)</li></ul><p>内置特效（<code>activeVariant</code>）：</p><ul><li><code>rim</code>：边缘光晕与高光描边</li><li><code>wave</code>：指针锚点的扩散波纹</li><li><code>prism</code>：棱镜折射的彩色带状高光</li><li><code>rhythm</code>：音律闪烁 + 可选音乐频谱柱（支持 <code>musicSpectrum</code>/<code>musicConfig</code>）</li><li><code>pulse</code>：呼吸/心跳式脉冲高光</li><li><code>glitch</code>：数字噪声/切片错位的故障感</li><li><code>frost</code>：霜雾凝结的颗粒纹理</li></ul><h4 id="新增一种特效-5-步内" tabindex="-1">新增一种特效（5 步内） <a class="header-anchor" href="#新增一种特效-5-步内" aria-label="Permalink to &quot;新增一种特效（5 步内）&quot;">​</a></h4><ol><li>在 <code>widgets/glass-button/effects/</code> 新建 <code>&lt;name&gt;-effect.ts</code>，导出 <code>create&lt;Name&gt;Effect(): GlassButtonEffect</code>。</li><li>在 [effect-types.ts](file:///Users/edeink/Documents/inkwell/src/demo/glass-card/widgets/glass-button/effects/effect-types.ts) 的 <code>GlassButtonEffectName</code> 中加入新名称字面量。</li><li>在 [effects/index.ts](file:///Users/edeink/Documents/inkwell/src/demo/glass-card/widgets/glass-button/effects/index.ts) 里导出新文件。</li><li>在 [glass-button/index.tsx](file:///Users/edeink/Documents/inkwell/src/demo/glass-card/widgets/glass-button/index.tsx) 更新 <code>GlassButtonActiveVariant</code> 与 <code>ensureEffects()</code> 映射。</li><li>在 [glass-button.effects.test.ts](file:///Users/edeink/Documents/inkwell/src/demo/glass-card/widgets/glass-button/<strong>tests</strong>/glass-button.effects.test.ts) 补一条覆盖用例（至少覆盖 <code>paint</code>）。</li></ol><h2 id="底图缓存-baselayer" tabindex="-1">底图缓存（baseLayer） <a class="header-anchor" href="#底图缓存-baselayer" aria-label="Permalink to &quot;底图缓存（baseLayer）&quot;">​</a></h2><p><code>FrostedGlassCard</code> 内部维护 <code>baseLayer</code>（离屏 canvas + ctx + key），用于缓存“静态底图内容”：</p><ul><li>背景图（可选，cover 铺满、居中裁剪）</li><li>无背景图时的渐变 + 装饰斑点</li><li>清晰窗口底色与渐变</li></ul><p>当 <code>baseLayer.key</code> 不变时，<code>canvas/context</code> 会被复用，从而避免重复分配与重复绘制静态内容。</p><p>key 的构成要点（高层描述）：</p><ul><li>尺寸与 dpr（像素尺寸变化必须重绘）</li><li>窗口布局（windowX/Y/W/H/R 变化必须重绘）</li><li>背景图相关（src/version 变化必须重绘）</li><li>主题色（primary/secondary/background 变化必须重绘）</li></ul><p>底图绘制函数抽在：[frosted-glass-card-paint.ts](file:///Users/edeink/Documents/inkwell/src/demo/glass-card/helpers/frosted-glass-card-paint.ts)</p><h2 id="磨砂绘制策略" tabindex="-1">磨砂绘制策略 <a class="header-anchor" href="#磨砂绘制策略" aria-label="Permalink to &quot;磨砂绘制策略&quot;">​</a></h2><p>磨砂只作用在“窗口外区域”，实现方式：</p><ol><li>用 <code>evenodd</code> 裁剪把窗口区域“挖洞”，得到窗口外区域的剪裁区域。</li><li>对 baseLayer 做模糊绘制： <ul><li>优先：<code>ctx.filter = blur(px)</code>（性能更好）</li><li>回退：多次小偏移采样近似模糊（兼容不支持 filter 的环境）</li></ul></li><li>叠加 <code>glassAlpha</code> 半透明覆盖层，增强“玻璃雾化”效果。</li><li>可选：<code>animate=true</code> 时绘制扫光高光。</li></ol><p>实现位置：[paintFrostedOverlay](file:///Users/edeink/Documents/inkwell/src/demo/glass-card/helpers/frosted-glass-card-paint.ts#L97-L167)</p><h2 id="清晰窗口绘制" tabindex="-1">清晰窗口绘制 <a class="header-anchor" href="#清晰窗口绘制" aria-label="Permalink to &quot;清晰窗口绘制&quot;">​</a></h2><p>清晰窗口的实现是“再绘制一遍 baseLayer，但只裁剪窗口区域”，保证窗口内不受模糊影响。</p><p>实现位置：[paintClearWindow](file:///Users/edeink/Documents/inkwell/src/demo/glass-card/helpers/frosted-glass-card-paint.ts#L170-L191)</p><h2 id="文本样式采样-只在必要时执行" tabindex="-1">文本样式采样（只在必要时执行） <a class="header-anchor" href="#文本样式采样-只在必要时执行" aria-label="Permalink to &quot;文本样式采样（只在必要时执行）&quot;">​</a></h2><p>为了让上层文字在不同背景下更易读，<code>FrostedGlassCard</code> 支持对 <code>textSampleRect</code> 指定的区域采样平均颜色，并推荐 <code>fill/stroke</code>：</p><ul><li>fast 路径：把区域缩放绘制到 1x1 采样器，再读 1 个像素（低开销）</li><li>回退路径：<code>getImageData</code> 读取并稀疏采样做加权平均（控制采样点数量）</li></ul><p>重要约束：</p><ul><li>采样不会在 <code>performLayout</code> 或 <code>paint</code> 中执行（避免每帧读像素）。</li><li>采样只会在两类时机触发： <ul><li>背景图 <code>image.onload</code>（底图已更新，尺寸有效时采样一次）</li><li><code>didUpdateWidget</code> 检测到与采样有关的属性变化时（主题/窗口/背景图/采样区域/回调变化）</li></ul></li></ul><p>相关实现：</p><ul><li>采样函数：[color-sampling.ts](file:///Users/edeink/Documents/inkwell/src/demo/glass-card/helpers/color-sampling.ts)</li><li>触发逻辑：[didUpdateWidget](file:///Users/edeink/Documents/inkwell/src/demo/glass-card/widgets/frosted-glass-card/index.ts#L275-L336)</li></ul><h2 id="测试覆盖点" tabindex="-1">测试覆盖点 <a class="header-anchor" href="#测试覆盖点" aria-label="Permalink to &quot;测试覆盖点&quot;">​</a></h2><p>测试文件：[frosted-glass-card.spec.ts](file:///Users/edeink/Documents/inkwell/src/demo/glass-card/<strong>tests</strong>/frosted-glass-card.spec.ts)</p><ul><li>基础绘制路径存在（底图 + 磨砂层 + 清晰窗口）</li><li>离屏底图缓存复用（避免重复创建 canvas）</li><li><code>windowRatio</code> 变化会刷新 <code>baseLayer.key</code> 但复用 canvas</li><li>约束不变时，绘制相关属性更新不应触发 <code>updateStaticCaches</code></li><li>约束变化/尺寸属性变化会触发布局并更新静态缓存</li></ul><h2 id="常见改动点" tabindex="-1">常见改动点 <a class="header-anchor" href="#常见改动点" aria-label="Permalink to &quot;常见改动点&quot;">​</a></h2><ul><li>调整磨砂强度：<code>blurPx</code></li><li>调整玻璃雾化：<code>glassAlpha</code></li><li>调整窗口布局：<code>windowRect</code> 或 <code>windowRatio</code></li><li>接入业务文本：优先通过 <code>GlassCardComposite</code> 在上层叠加，避免文本被磨砂影响</li></ul>',47)])])}const f=s(o,[["render",t]]);export{g as __pageData,f as default};
