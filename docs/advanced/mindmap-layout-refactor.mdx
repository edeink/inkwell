---
title: 思维导图布局重构说明
slug: /advanced/mindmap-layout-refactor
---

- 目标：统一布局的单一来源，消除重复控制与元素堆积。
- 单一来源：仅由 `src/demo/mindmap/custom-widget/mindmap-layout.ts` 的 `performLayout` 控制布局。
- 兼容处理：`src/demo/mindmap/controller/modules/layout.ts` 移除全部布局逻辑，保留空壳接口 `attach`、`markAffected` 以维持模块调用兼容。
- 场景渲染：`src/demo/mindmap/scene.tsx` 改为静态 JSX，不再进行任何数据映射或位置计算。
- 堆积修复：布局计算基于节点尺寸与间距，自动居中内容；连接线为绘制型子组件，不参与尺寸与偏移计算，避免所有元素落在 `(0,0)`。
- 测试验证：
  - `src/demo/mindmap/custom-widget/__tests__/layout-single-source.test.ts`：验证布局只由 `performLayout` 产生，节点偏移不相同且连接线偏移为 `(0,0)`；忽略外部 `positions` 字段。
  - `src/demo/mindmap/scene.test.tsx`：验证 `createScene` 返回静态结构（节点 6、连接线 5），且不存在 `positions` 属性。
- 影响范围：保持 `CrudModule` 对 `LayoutModule.markAffected` 的调用兼容（现为无副作用），渲染流程由 `Runtime` 触发布局重算。
