---
title: 思维导图
sidebar_label: 思维导图
---

import { MindmapDemo } from '@mindmap/app';

# 思维导图

这是一个基于 Inkwell 框架实现的思维导图示例，展示了如何使用 Inkwell 构建高性能的交互式图形应用。

## 在线演示

```tsx mode:edit
/** @jsxImportSource @/utils/compiler */
<MindmapDemo />
```

### 组件参数 (Props)

| 属性 | 类型 | 默认值 | 说明 |
| :--- | :--- | :--- | :--- |
| `width` | `number` | - | 视口宽度 |
| `height` | `number` | - | 视口高度 |

## 功能特性

该示例实现了思维导图的核心功能，包括：

1.  **节点管理**
    *   **根节点 (Root)**: 导图的中心主题。
    *   **子节点 (Child)**: 支持无限层级的子节点扩展。
    *   **同级节点 (Sibling)**: 支持在当前节点上方或下方添加同级节点。
    *   **布局自动调整**: 采用 `MindMapLayout` 实现自动化的树状布局算法（`treeBalanced`），确保节点互不重叠且视觉平衡。

2.  **交互操作**
    *   **拖拽 (Drag)**: 支持拖拽节点改变位置（演示中实现了拖拽逻辑，但配合自动布局时通常用于重新排序或临时调整，具体行为取决于 `MindMapLayout` 的约束）。
    *   **缩放与平移 (Zoom & Pan)**: 通过 `Viewport` 组件实现画布的无限漫游和缩放查看。
    *   **选中与激活**: 点击节点进行选中，支持键盘快捷键操作（如 `Tab` 添加子节点，`Enter` 添加同级节点）。
    *   **编辑**: 双击节点文本进行编辑。

3.  **连接线 (Connector)**
    *   使用贝塞尔曲线或折线自动连接父子节点。
    *   样式可配置（粗细、颜色、虚线等）。

## Inkwell 最佳实践

本示例展示了 Inkwell 框架的几个核心概念：

### 1. 组件化开发 (Widgets)
整个导图由多个细粒度的 Widget 组合而成：
*   `Scene`: 顶层容器，管理全局状态（GraphState）。
*   `MindMapNode`: 自定义 Widget，封装了节点的绘制（Container + Text）和交互逻辑（事件处理）。
*   `Connector`: 用于绘制连接线。

### 2. 状态管理
使用 `StatefulWidget` (`Scene`) 来管理整个图的数据结构（Nodes & Edges）。当数据变化时，通过 `setState` 触发重建，Inkwell 的 Diff 算法会高效更新视图。

### 3. 自定义布局 (Custom Layout)
`MindMapLayout` 是一个自定义布局组件，它通过重写 `performLayout` 方法，实现了复杂的树形结构排版算法。这展示了 Inkwell 强大的布局扩展能力。

### 4. 高性能渲染
得益于 Canvas 渲染和 Inkwell 的脏矩形检测机制，即使在节点数量较多时，也能保持流畅的帧率。

### 5. 缩放兼容性 (Scale Compatibility)
在实现交互组件（如 `MindMapNodeToolbar`）时，需要注意坐标系统的转换。
- **屏幕坐标 (Screen Coordinates)**: 用户点击或触摸的原始坐标。
- **世界坐标 (World Coordinates)**: 画布内容的坐标。
- **本地坐标 (Local Coordinates)**: 组件内部的坐标。

当 Viewport 发生缩放或平移时，屏幕坐标需要经过逆变换才能正确映射到组件的本地坐标。示例中通过 `transformToNodeLocal` 等方法确保了工具栏按钮在任何缩放比例下都能精准响应点击。

### 6. 类型安全的组件查找 (Type-Safe Component Lookup)
在大型应用中，通过字符串查找组件（`findWidget`）容易出错且难以维护。本项目强制使用枚举（Enum）来管理组件类型。
- **定义**: 在 `type.ts` 中定义 `CustomComponentType` 枚举。
- **使用**: 在 `findWidget` 和 `key` 属性中统一使用枚举值，严禁硬编码字符串（如 `'#MindMapViewport'`）。
- **示例**:
  ```typescript
  // ❌ 错误：硬编码字符串
  findWidget(root, '#MindMapViewport');
  
  // ✅ 正确：使用枚举
  import { CustomComponentType } from './type';
  findWidget(root, `#${CustomComponentType.MindMapViewport}`);
  ```

## 代码结构

*   `src/demo/mindmap/scene.tsx`: 场景入口，定义数据状态和渲染逻辑。
*   `src/demo/mindmap/custom-widget/mindmap-node.tsx`: 节点组件实现。
*   `src/demo/mindmap/custom-widget/mindmap-layout.ts`: 布局算法实现。
*   `src/demo/mindmap/custom-widget/connector.ts`: 连接线实现。

